name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run ESLint
        run: bun run lint

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build frontend
        run: bun run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: dist/
          retention-days: 7

  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Type check
        run: bunx tsc --noEmit

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  validate-env:
    name: Validate Environment Config
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo "❌ .env.example file is missing"
            exit 1
          fi
          echo "✅ .env.example file exists"

      - name: Check required environment variables
        run: |
          required_vars=(
            "SCHWAB_CLIENT_ID"
            "SCHWAB_CLIENT_SECRET"
            "SCHWAB_REDIRECT_URI"
            "SUPABASE_URL"
            "SUPABASE_ANON_KEY"
            "SUPABASE_SERVICE_KEY"
            "OPENAI_API_KEY"
            "GOOGLE_API_KEY"
          )

          for var in "${required_vars[@]}"; do
            if ! grep -q "^${var}=" .env.example; then
              echo "❌ Missing ${var} in .env.example"
              exit 1
            fi
          done

          echo "✅ All required environment variables present in .env.example"

  validate-schema:
    name: Validate Database Schema
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate SQL schema exists
        run: |
          if [ ! -f supabase-schema.sql ]; then
            echo "❌ supabase-schema.sql file is missing"
            exit 1
          fi
          echo "✅ Database schema file exists"

      - name: Check SQL syntax
        run: |
          # Basic SQL syntax validation
          if ! grep -q "CREATE TABLE" supabase-schema.sql; then
            echo "❌ No CREATE TABLE statements found"
            exit 1
          fi
          echo "✅ SQL schema appears valid"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, build-frontend, typecheck, security-scan, validate-env, validate-schema]
    if: always()

    steps:
      - name: Check CI Status
        run: |
          echo "## CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All checks passed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Code Linting" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Frontend Build" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ TypeScript Type Check" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Environment Validation" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Database Schema Validation" >> $GITHUB_STEP_SUMMARY
